<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Spotify'dan JSON Aktar</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #f3f3f3;
    }
    .btn {
      padding: 10px 20px;
      background: #1DB954;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      border-radius: 5px;
    }
    .btn:hover {
      background: #14833b;
    }
    .box {
      background: white;
      padding: 2em;
      border-radius: 10px;
      max-width: 700px;
      margin: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    pre {
      background: #eee;
      padding: 1em;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="box">
    <h2>üéµ Spotify'dan JSON Formatƒ±nda Veri Aktar</h2>
    <button class="btn" onclick="authorizeSpotify()">üîë Spotify‚Äôa Giri≈ü Yap</button>
    <div id="status" style="margin: 1em 0;"></div>
    <pre id="output"></pre>
    <button class="btn" id="download" style="display:none;" onclick="downloadJSON()">‚¨áÔ∏è JSON ƒ∞ndir</button>
  </div>

  <script>
    const client_id = 'a7de2da91b9e4003b5415b2c9fb0715a'; // ‚Üê kendi client ID'in
    const redirect_uri = 'https://yigittaybakan.github.io/spotify-exporter/'; // GitHub Pages adresin

    // 1. Spotify'a giri≈ü ve token alma
    function authorizeSpotify() {
      const scope = 'user-library-read playlist-read-private';
      const authURL = `https://accounts.spotify.com/authorize?client_id=${client_id}&response_type=token&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scope)}`;
      window.location.href = authURL;
    }

    // 2. Token ile verileri √ßek
    async function fetchSpotifyData(token) {
      const headers = { Authorization: `Bearer ${token}` };
      const allPlaylists = [];
      document.getElementById("status").innerText = '‚è≥ √áalma listeleri getiriliyor...';

      // T√ºm √ßalma listeleri
      let playlistsURL = 'https://api.spotify.com/v1/me/playlists?limit=50';
      while (playlistsURL) {
        const res = await axios.get(playlistsURL, { headers });
        for (const pl of res.data.items) {
          const tracks = [];
          let tracksURL = pl.tracks.href;
          // Liste i√ßindeki t√ºm ≈üarkƒ±lar
          while (tracksURL) {
            const tRes = await axios.get(tracksURL, { headers });
            for (const t of tRes.data.items) {
              if (t.track) {
                tracks.push({
                  title: t.track.name,
                  artist: t.track.artists.map(a => a.name).join(', ')
                });
              }
            }
            tracksURL = tRes.data.next;
          }
          allPlaylists.push({ playlist: pl.name, tracks });
        }
        playlistsURL = res.data.next;
      }

      // Beƒüenilen ≈üarkƒ±lar
      document.getElementById("status").innerText = '‚è≥ Beƒüenilen ≈üarkƒ±lar getiriliyor...';
      const likedTracks = [];
      let likedURL = 'https://api.spotify.com/v1/me/tracks?limit=50';
      while (likedURL) {
        const res = await axios.get(likedURL, { headers });
        for (const item of res.data.items) {
          if (item.track) {
            likedTracks.push({
              title: item.track.name,
              artist: item.track.artists.map(a => a.name).join(', ')
            });
          }
        }
        likedURL = res.data.next;
      }

      // Final veri
      const exportData = [
        { playlist: "‚ù§Ô∏è Beƒüenilen ≈ûarkƒ±lar", tracks: likedTracks },
        ...allPlaylists
      ];

      document.getElementById("output").textContent = JSON.stringify(exportData, null, 2);
      document.getElementById("download").style.display = 'inline-block';
      document.getElementById("status").innerText = `‚úÖ ${allPlaylists.length} liste ve ${likedTracks.length} beƒüeni aktarƒ±ldƒ±.`;
      window.exportData = exportData;
    }

    // 3. JSON olarak indirme
    function downloadJSON() {
      const data = new Blob([JSON.stringify(window.exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'spotify_sarkilar.json';
      a.click();
    }

    // 4. Sayfa y√ºklendiƒüinde token varsa otomatik veri √ßek
    window.addEventListener('load', () => {
      if (window.location.hash.includes('access_token')) {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get('access_token');
        fetchSpotifyData(token);
      }
    });
  </script>
</body>
</html>
