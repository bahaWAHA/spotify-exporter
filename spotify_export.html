<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Spotify'dan JSON Aktar</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f3f3f3; }
    .btn { padding: 10px 20px; background: #1DB954; color: white; border: none; cursor: pointer; font-size: 16px; }
    .btn:hover { background: #14833b; }
    .box { background: white; padding: 2em; border-radius: 10px; max-width: 600px; margin: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    pre { background: #eee; padding: 1em; border-radius: 8px; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="box">
    <h2>🎵 Spotify'dan JSON Olarak Şarkı Verisi Aktar</h2>
    <button class="btn" onclick="authorizeSpotify()">Spotify’a Giriş Yap</button>
    <div id="status"></div>
    <pre id="output"></pre>
    <button class="btn" id="download" style="display:none;" onclick="downloadJSON()">JSON İndir</button>
  </div>

  <script>
    const client_id = 'a7de2da91b9e4003b5415b2c9fb0715a'; // Senin Spotify Client ID

    // Burada kesinlikle dosya adı ile birlikte tam URL olmalı
    const redirect_uri = 'https://bahawaha.github.io/spotify-exporter/spotify_export.html';

    function authorizeSpotify() {
      const scope = 'user-library-read playlist-read-private';
      const authURL = `https://accounts.spotify.com/authorize?client_id=${client_id}&response_type=token&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scope)}`;
      window.location.href = authURL;
    }

    async function fetchSpotifyData(token) {
      document.getElementById("status").innerText = '⏳ Veri alınıyor...';

      const headers = { Authorization: `Bearer ${token}` };
      const allPlaylists = [];

      let playlistsURL = 'https://api.spotify.com/v1/me/playlists?limit=50';
      while (playlistsURL) {
        const res = await axios.get(playlistsURL, { headers });
        for (const pl of res.data.items) {
          const tracks = [];
          let tracksURL = pl.tracks.href;
          while (tracksURL) {
            const tRes = await axios.get(tracksURL, { headers });
            for (const t of tRes.data.items) {
              if (t.track) {
                tracks.push({
                  title: t.track.name,
                  artist: t.track.artists.map(a => a.name).join(', ')
                });
              }
            }
            tracksURL = tRes.data.next;
          }

          allPlaylists.push({
            playlist: pl.name,
            tracks: tracks
          });
        }
        playlistsURL = res.data.next;
      }

      const likedTracks = [];
      let likedURL = 'https://api.spotify.com/v1/me/tracks?limit=50';
      while (likedURL) {
        const res = await axios.get(likedURL, { headers });
        for (const item of res.data.items) {
          if (item.track) {
            likedTracks.push({
              title: item.track.name,
              artist: item.track.artists.map(a => a.name).join(', ')
            });
          }
        }
        likedURL = res.data.next;
      }

      const exportData = [
        { playlist: "❤️ Beğenilen Şarkılar", tracks: likedTracks },
        ...allPlaylists
      ];

      document.getElementById("output").textContent = JSON.stringify(exportData, null, 2);
      document.getElementById("download").style.display = 'inline-block';
      document.getElementById("status").innerText = '✅ Veriler alındı!';
      window.exportData = exportData;
    }

    function downloadJSON() {
      const data = new Blob([JSON.stringify(window.exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'spotify_sarkilar.json';
      a.click();
    }

    window.addEventListener('load', () => {
      if (window.location.hash.includes('access_token')) {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get('access_token');
        fetchSpotifyData(token);
      }
    });
  </script>
</body>
</html>
