<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Spotify'dan JSON Aktar</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f3f3f3; }
    .btn { padding: 10px 20px; background: #1DB954; color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 5px; }
    .btn:hover { background: #14833b; }
    .box { background: white; padding: 2em; border-radius: 10px; max-width: 600px; margin: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    pre { background: #eee; padding: 1em; border-radius: 8px; max-height: 300px; overflow-y: auto; font-size: 14px; }
    #status { margin: 1em 0; font-weight: bold; }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #1DB954; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="box">
    <h2>üéµ Spotify'dan JSON Olarak ≈ûarkƒ± Verisi Aktar</h2>
    <button class="btn" onclick="authorizeSpotify()">Spotify‚Äôa Giri≈ü Yap</button>
    <div id="status"></div>
    <pre id="output"></pre>
    <button class="btn" id="download" style="display:none;" onclick="downloadJSON()">JSON ƒ∞ndir</button>
  </div>

  <script>
    const client_id = 'a7de2da91b9e4003b5415b2c9fb0715a';
    const redirect_uri = 'https://bahawaha.github.io/spotify-exporter/spotify_export.html';

    function authorizeSpotify() {
      const scope = 'user-library-read playlist-read-private';
      const authURL = `https://accounts.spotify.com/authorize?client_id=${client_id}&response_type=token&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scope)}`;
      console.log('Yetkilendirme URL:', authURL);
      window.location.href = authURL;
    }

    async function fetchWithRetry(url, headers, retries = 3, delay = 1000) {
      for (let i = 0; i < retries; i++) {
        try {
          console.log(`API isteƒüi: ${url}`);
          const response = await axios.get(url, { headers });
          return response;
        } catch (error) {
          console.error(`Hata (${url}):`, error);
          if (error.response && error.response.status === 429 && i < retries - 1) {
            const retryAfter = error.response.headers['retry-after'] || delay;
            console.log(`Rate limit, ${retryAfter}s bekleniyor...`);
            await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
            continue;
          }
          throw error;
        }
      }
    }

    async function fetchSpotifyData(token) {
      try {
        console.log('Token alƒ±ndƒ±:', token);
        document.getElementById("status").innerHTML = '‚è≥ Veri alƒ±nƒ±yor... <span class="spinner"></span>';

        const headers = { Authorization: `Bearer ${token}` };
        const allPlaylists = [];

        // √áalma listelerini √ßek
        let playlistsURL = 'https://api.spotify.com/v1/me/playlists?limit=50';
        while (playlistsURL) {
          const res = await fetchWithRetry(playlistsURL, headers);
          console.log('√áalma listeleri alƒ±ndƒ±:', res.data.items.length);
          for (const pl of res.data.items) {
            const tracks = [];
            let tracksURL = pl.tracks.href;
            while (tracksURL) {
              const tRes = await fetchWithRetry(tracksURL, headers);
              console.log(`√áalma listesi "${pl.name}" i√ßin ${tRes.data.items.length} ≈üarkƒ± alƒ±ndƒ±`);
              for (const t of tRes.data.items) {
                if (t.track) {
                  tracks.push({
                    title: t.track.name,
                    artist: t.track.artists.map(a => a.name).join(', '),
                    album: t.track.album.name,
                    spotify_url: t.track.external_urls.spotify
                  });
                }
              }
              tracksURL = tRes.data.next;
            }
            allPlaylists.push({
              playlist: pl.name,
              tracks: tracks
            });
          }
          playlistsURL = res.data.next;
        }

        // Beƒüenilen ≈üarkƒ±larƒ± √ßek
        const likedTracks = [];
        let likedURL = 'https://api.spotify.com/v1/me/tracks?limit=50';
        while (likedURL) {
          const res = await fetchWithRetry(likedURL, headers);
          console.log('Beƒüenilen ≈üarkƒ±lar alƒ±ndƒ±:', res.data.items.length);
          for (const item of res.data.items) {
            if (item.track) {
              likedTracks.push({
                title: item.track.name,
                artist: item.track.artists.map(a => a.name).join(', '),
                album: item.track.album.name,
                spotify_url: item.track.external_urls.spotify
              });
            }
          }
          likedURL = res.data.next;
        }

        const exportData = [
          { playlist: "‚ù§Ô∏è Beƒüenilen ≈ûarkƒ±lar", tracks: likedTracks },
          ...allPlaylists
        ];

        document.getElementById("output").textContent = JSON.stringify(exportData, null, 2);
        document.getElementById("download").style.display = 'inline-block';
        document.getElementById("status").innerText = '‚úÖ Veriler ba≈üarƒ±yla alƒ±ndƒ±!';
        window.exportData = exportData;
      } catch (error) {
        console.error('Hata:', error);
        document.getElementById("status").innerText = `‚ùå Hata: ${error.message}`;
      }
    }

    function downloadJSON() {
      const data = new Blob([JSON.stringify(window.exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'spotify_sarkilar.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    window.addEventListener('load', () => {
      console.log('Sayfa y√ºklendi, hash:', window.location.hash);
      if (window.location.hash.includes('access_token')) {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get('access_token');
        if (token) {
          console.log('Token bulundu, veri √ßekiliyor...');
          fetchSpotifyData(token);
        } else {
          document.getElementById("status").innerText = '‚ùå Token alƒ±namadƒ±!';
          console.error('Token alƒ±namadƒ±, hash:', hash);
        }
      }
    });
  </script>
</body>
</html>
